# SEgene_RegionAnalyzer

*(For the Japanese version of this README, please see [README_ja.md](https://github.com/hamamoto-lab/SEgene/blob/main/SEgene_region_analyzer/README_ja.md).)*

**SEgene_RegionAnalyzer** is a component of the **SEgene project** and serves as a Python tool package designed to evaluate and analyze super-enhancer (SE) activity and relevance in genomic regions of interest using public database information.

> **Note**: This tool is **currently under development**, and the program file structure and usage methods may change significantly between versions.

The SEgene project consists primarily of the following components, with SEgene_RegionAnalyzer extending the analytical toolchain:
* [peak_to_gene_links](https://github.com/hamamoto-lab/SEgene/tree/main/peak_to_gene_links): Analyzes correlation information between gene expression and enhancer peaks
* [SE_to_gene_links](https://github.com/hamamoto-lab/SEgene/tree/main/SE_to_gene_links): Analyzes super-enhancers using correlation information
* **SEgene_RegionAnalyzer** (this tool): Performs detailed characterization of SE regions identified by SEgene and integrates with public databases

This tool extends the SEgene project workflow and enables the following analyses:

1. **Input Data**:
   * TSV-formatted merged SE region lists generated by the [SE_to_gene_links](https://github.com/hamamoto-lab/SEgene/tree/main/SE_to_gene_links) module
   * Or genomic regions defined in standard BED format

2. **Analysis Process**:
   * Integration of specified regions with public data
   * Enrichment analysis by tissue type and other parameters
   * Statistical significance evaluation

3. **Output Results**:
   * Detailed analysis reports in TSV format
   * Visually comprehensible HTML reports
   * Statistical information and figures for each region

Currently, the tool supports **human genome hg38** and **SEdb 2.0** data. Support for additional databases and analytical functions will be expanded and updated in the future.

Currently supported databases:
* [SEdb 2.0](http://www.licpathway.net/sedb/) - A comprehensive database of super-enhancers in humans and mice

## Table of Contents
- [Features](#features)
- [Requirements](#requirements)
- [Setup](#setup)
- [Usage](#usage)
- [Output Format](#output-format)
- [Future Development](#future-development)
- [License](#license)
- [Citation](#citation)

## Features

* **Batch Processing:** Analyze multiple genomic regions defined in TSV or BED files in a single run
* **Public Database Integration:** Utilize super-enhancer (large enhancer regions with powerful influence on gene expression regulation) data and sample metadata
* **Tissue Enrichment Analysis:** Statistically evaluate whether SEs associated with specified regions are enriched in specific tissue types
* **Flexible Input:** Specify target regions using TSV files derived from SEgene or standard BED files
* **Comprehensive Output:**
    * Generate individual directories for each region's analysis results (figures, statistics, related data)
    * Output an aggregated TSV file of all region results
    * Generate HTML reports for each region (optional)

## Requirements

* **Python:** 3.10 or later recommended
* **Main Python Libraries:**
    * pandas: Data manipulation and analysis
    * numpy: Numerical computation
    * scipy: Scientific and technical computing, statistical analysis
    * statsmodels: Statistical model building
    * pybedtools: BED file operations
    * matplotlib / seaborn: Graph plotting
    * Jinja2: Template engine for HTML report generation
    * pyarrow: Required for reading and writing Parquet files

    **Note**: Currently, `requirements.txt` or `environment.yml` files are not provided. They may be provided in the future, but for now, you need to install the above libraries manually.

* **External Tools:**
    * [Bedtools](https://bedtools.readthedocs.io/): Used internally by pybedtools.

* **Data:**
    * The following files downloaded from [SEdb 2.0](http://www.licpathway.net/sedb/) are required:
        * `human_sample_information_sedb2.txt` (Sample metadata)
        * `SE_package_hg38.bed` (SE definition BED file)

## Setup

1. **Clone the Repository:**
    ```bash
    git clone https://github.com/hamamoto-lab/SEgene.git
    cd SEgene/SEgene_region_analyzer # Navigate to the SEgene_region_analyzer directory in the cloned repository
    ```

2. **Prepare Python Environment:**
    
    Below are examples of environment setup using conda or pip. You need to manually install the required libraries.

    **Using conda:**
    ```bash
    # Create environment
    conda create -n sedb_analyzer python=3.10
    # Activate environment
    conda activate sedb_analyzer
    # Install main libraries
    conda install pandas numpy scipy statsmodels matplotlib seaborn jinja2
    conda install -c bioconda pybedtools
    conda install -c conda-forge pyarrow fastparquet
    ```

    **Using pip:**
    ```bash
    # Create virtual environment
    python -m venv venv
    # Activate environment
    source venv/bin/activate  # Linux/macOS
    # or
    .\venv\Scripts\activate  # Windows
    # Install main libraries
    pip install pandas numpy scipy statsmodels matplotlib seaborn jinja2 pybedtools pyarrow fastparquet
    ```

    **Note**: `environment.yml` or `requirements.txt` files may be provided in the future.

3. **Download and Prepare SEdb Data:**
* Access the [SEdb 2.0 Download page](http://www.licpathway.net/sedb/download.php).
* Download `human_sample_information_sedb2.txt` from the "Sample information" section.
* Download "Super-enhancer information" (`SE_package_hg38.bed`) for Human (hg38) from the "Package of SE, SE element and TE" section.
* (If the server is busy, please try again later)
* **Important:** This tool expects data files to be placed in a `data/SEdb` structure in the **parent directory** of `SEgene_region_analyzer`. Please place the downloaded files in the following directory structure (`your_project_root` is where `SEgene_region_analyzer` exists):

```
your_project_root/
├── SEgene_region_analyzer/  <-- Where this repository's code is located
│   ├── run_batch_processor.py
│   └── ... (other scripts)
└── data/                 <-- Create at the same level as SEgene_region_analyzer
    └── SEdb/
        ├── human_sample_information_sedb2.txt
        └── SE_package_hg38.bed 
```

Example commands to create `data/SEdb` directory at the same level as `SEgene_region_analyzer` and place the downloaded files:
```bash
# Assuming you are in the SEgene_region_analyzer directory
cd .. # Move to parent directory
mkdir -p data/SEdb
mv /path/to/downloaded/human_sample_information_sedb2.txt ./data/SEdb/
mv /path/to/downloaded/SE_package_hg38.bed ./data/SEdb/
cd SEgene_region_analyzer # Return to original directory (optional)
```

## Usage

Analysis is mainly performed using the batch script `run_batch_processor.py`. **This script must be run from within the `SEgene_region_analyzer` directory.**

First, navigate to the `SEgene_region_analyzer` directory:
```bash
cd path/to/SEgene_region_analyzer
```

Below are basic execution examples and explanations of the main options.

### Basic Execution Example (TSV Input)

*(The example below references data files (`--bed_file`, `--metadata_file`) in `data/SEdb` in the parent directory of `SEgene_region_analyzer`)*

```bash
python run_batch_processor.py \
    --input_file <path_to_input_TSV_file> \
    --input_format tsv \
    --bed_file ../data/SEdb/SE_package_hg38_cleaned.bed \
    --metadata_file ../data/SEdb/human_sample_information_sedb2.txt \
    --output_dir <main_output_directory_path> \
    # --max_rows <integer>      # (optional)
```

### Basic Execution Example (BED Input)

*(The example below references data files (`--bed_file`, `--metadata_file`) in `data/SEdb` in the parent directory of `SEgene_region_analyzer`)*

```bash
python run_batch_processor.py \
    --input_file <path_to_input_BED_file> \
    --input_format bed \
    --bed_file ../data/SEdb/SE_package_hg38_cleaned.bed \
    --metadata_file ../data/SEdb/human_sample_information_sedb2.txt \
    --output_dir <main_output_directory_path> \
    # --max_rows <integer>      # (optional)
```
*(Note: Replace `<path_to_input_TSV_file>`, `<path_to_input_BED_file>`, `<main_output_directory_path>` with actual paths. Adjust the data file paths (`--bed_file`, `--metadata_file`) according to where you placed them during setup.)*

### Main Options

* **`--input_file <path>`**: (Required) Path to the file containing the list of regions to analyze.
  * Specifies region definitions in TSV or BED format.
  * For TSV format, it is expected to follow the SEgene output format.

* **`--input_format <tsv|bed>`**: (Optional, default: tsv) Specifies the format of `--input_file`.
  * `tsv`: Tab-separated file format, typically output from SEgene
  * `bed`: Standard BED format, allowing specification of custom genomic regions

* **`--bed_file <path>`**: (Required) Path to the SE BED file downloaded from SEdb.
  * This file contains definitions of all super-enhancer regions.
  * Example: `../data/SEdb/SE_package_hg38.bed` (if located in `data/SEdb` in the parent directory of `SEgene_region_analyzer`)

* **`--metadata_file <path>`**: (Required) Path to the sample metadata file downloaded from SEdb.
  * This file contains detailed information for each sample (such as tissue type).
  * Example: `../data/SEdb/human_sample_information_sedb2.txt` (if located in `data/SEdb` in the parent directory of `SEgene_region_analyzer`)

* **`--output_dir <path>`**: (Required) Main directory to save all outputs (intermediate results, final results).
  * Analysis results will be saved hierarchically within this directory.

* **`--max_rows <integer>`**: (Optional) Specifies the maximum number of rows to process from the input file for testing.
  * Useful for testing with a small subset before using large files.

* **`--debug`**: (Optional) Enables debug mode.
  * Not necessary for normal use, but helpful for detailed logging when issues arise.

* **`--log_file <path>`**: (Optional) Specifies the file path to save logs for this batch script.
  * If not specified, logs will only be output to the console.

### Input File Formats

#### TSV Format (`--input_format tsv`)
* Tab-separated file.
* The first column must contain region IDs. The current script expects parsing in the format `chrX_START_END` (example: `chr1_1109435_1174178`).
* Other columns are preserved and will be included in the final output TSV.

#### BED Format (`--input_format bed`)
* Standard BED format (tab-separated).
* The first 3 columns (chromosome, start position, end position) are used as region information. No header row is expected.
* In the current implementation, other columns in the BED file (such as name) are not carried over to the final results.

## Output Format

Output is generated in the directory specified by `--output_dir` with the following structure:

```
<main_output_directory>/
├── 00_preprocessed_data/       # Background data package generated by Preprocessor
│   ├── data/
│   │   ├── bed_data.parquet
│   │   ├── sample_info.parquet
│   │   └── cell_id_counts.parquet
│   ├── statistics/
│   │   ├── statistics.json
│   │   └── ... (other statistic files)
│   └── metadata.json
├── 01_batch_region_results/    # Analysis results for each region
│   ├── region_1_chr1_.../      # Results for Region 1
│   │   ├── extractor_output/   # Extractor output
│   │   │   ├── bed_data.parquet
│   │   │   ├── sample_info.parquet
│   │   │   ├── distributions/
│   │   │   │   ├── tissue_counts.parquet
│   │   │   │   └── ...
│   │   │   ├── summary.json
│   │   │   └── metadata.json
│   │   └── analyzer_output/    # Analyzer output
│   │       ├── machine_readable/
│   │       │   ├── data/
│   │       │   │   ├── enrichment_results.parquet
│   │       │   │   └── ...
│   │       │   └── metadata.json
│   │       ├── human_readable/
│   │       │   ├── figures/
│   │       │   │   ├── tissue_enrichment.png/svg
│   │       │   │   └── ...
│   │       │   ├── tables/
│   │       │   │   ├── enrichment_results.csv/txt
│   │       │   │   └── ...
│   │       │   └── summary.txt
│   │       ├── summary.json
│   │       └── index.html (HTML report)
│   └── region_2_chr7_.../      # Results for Region 2
│       └── ...
└── batch_analysis_results_YYYYMMDD_HHMMSS.tsv  # ★ Final aggregated results TSV
```

### Main Additional Columns in Final TSV File

The `batch_analysis_results_YYYYMMDD_HHMMSS.tsv` file includes the following information:

* **`se_unique_sample_count`**: Number of unique sample IDs related to SEs found by the Extractor in the region.
* **`linked_sample_count`**: Number of samples from the above IDs that were successfully linked to metadata.
* **`significant_tissues`**: List of tissue types determined by the Analyzer to be significantly enriched (comma-separated).
* **`significant_tissues_fc`**: List of corresponding Fold Changes (comma-separated).
* **`significant_tissues_pvalue`**: List of corresponding P values (comma-separated).
* **`significant_tissues_fdr`**: List of corresponding adjusted P values (FDR) (comma-separated).
* **`processing_error`**: Error message (partial) if an error occurred during processing.

## Future Development

SEgene_RegionAnalyzer is still under development, and the following expansions are planned:

* **Extended Database Support**: Currently only SEdb 2.0 is supported, but support for other super-enhancer databases will be added sequentially.
* **Enhanced Analysis Functions**: Implementation of more diverse statistical analysis methods and improved visualization capabilities are planned.
* **Support for Other Genome Assemblies**: Support for mm10 (mouse) is also under consideration.

## License

This program is released under the MIT License. For more details, please refer to the [LICENSE](https://github.com/hamamoto-lab/SEgene/blob/main/LICENSE) file.

## Citation

If you use this tool in your research, please cite:

Shinkai, N., Asada, K., Machino, H., Takasawa, K., Takahashi, S., Kouno, N., Komatsu, M., Hamamoto, R., & Kaneko, S. (2025). SEgene identifies links between super enhancers and gene expression across cell types. *npj Systems Biology and Applications*, 11(1), 49. https://doi.org/10.1038/s41540-025-00533-x