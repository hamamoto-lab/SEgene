# CLI Tools for SE-Gene Correlation Analysis

*(For the Japanese version of this README, please see [README_ja.md](https://github.com/hamamoto-lab/SEgene/blob/main/cli_tools/README_ja.md).)*

This directory contains CLI scripts for performing a series of analyses using ChIP-Seq and RNA data, including:

1. GTF file generation for featureCount
2. BAM file list generation
3. featureCounts job execution
4. Read count retrieval for BAM files
5. Merging featureCounts output and CPM calculation
6. CPM data 0-indexed conversion
7. SE-gene correlation analysis

The following procedures assume you have already created `temp_full_df_info.pkl` using [SEgene_package](https://github.com/hamamoto-lab/SEgene/blob/main/SE_to_gene_links/README.md), along with RNA TPM data and ChIP-Seq BAM files.

You can obtain `temp_full_df_info.pkl` by executing the following method in your SEgene Jupyter instance from [SEgene_package](https://github.com/hamamoto-lab/SEgene/blob/main/SE_to_gene_links/README.md):

```python
SEgeneJupyterInstance.analyze_merge_SE_info(save_info_pkl="temp_full_df_info.pkl")
```

For more detailed usage of [SEgene_package](https://github.com/hamamoto-lab/SEgene/blob/main/SE_to_gene_links/README.md), please refer to the [tutorial notebooks](https://github.com/hamamoto-lab/SEgene/tree/main/SE_to_gene_links/notebooks).

## File Structure

```
cli_tools/
├── bam_count.sh                                    # Retrieve read counts from BAM files
├── convert_merge_featurecount_CPM_zero_indexed.py  # Convert CPM data to 0-indexed
├── correlation_analysis.py                         # SE-gene correlation analysis
├── generate_file_list.sh                          # Generate BAM file list
├── generate_gtf.py                                # Generate GTF file
├── gtf_processing.py                              # GTF processing utilities
├── merge_featurecount_CPM.py                      # Merge featureCounts results and calculate CPM
├── run_featurecounts_array.sh                     # Run featureCounts jobs (for array jobs)
└── run_featurecounts_local.sh                     # Run featureCounts jobs (for local execution)
```

## Requirements

- **[featureCounts](http://subread.sourceforge.net/)** (v2.0.6) and **[samtools](http://www.htslib.org/)** (v1.15.1) installed and accessible in PATH.
- **Python 3.10.8** and related libraries (`pandas`, `numpy`, `matplotlib`, etc.) installed.
- Help for each script can be accessed using `python <script>.py --help`.

## Required Files

- **`temp_full_df_info.pkl`**: pkl file generated by running Jupyter from [SEgene_package](https://github.com/hamamoto-lab/SEgene/blob/main/SE_to_gene_links/README.md).
- **RNA TPM file (CSV)**: Gene expression data for correlation analysis.
- **ChIP-Seq BAM files**: Required for featureCounts.

BAM files and RNA CSV formats should be properly formatted beforehand. The RNA CSV format should be identical to those used in [P2GL](https://github.com/hamamoto-lab/SEgene/blob/main/peak_to_gene_links/README.md) and [SEgene_package](https://github.com/hamamoto-lab/SEgene/blob/main/SE_to_gene_links/README.md).

## Analysis Workflow

First, clone the SEgene repository and create a working directory (calculate_correlation) for correlation analysis. (Replace `/path/to/calculate_correlation` with your desired working directory path)

```bash
# Clone repository
git clone https://github.com/hamamoto-lab/SEgene.git

# Create working directory for correlation analysis and copy necessary scripts
mkdir -p /path/to/calculate_correlation
cp SEgene/cli_tools/* /path/to/calculate_correlation/
cd /path/to/calculate_correlation
```

Follow these steps for analysis:

### 1. Generate GTF File for featureCount

Create a GTF file for featureCounts using `temp_full_df_info.pkl`:

```bash
python generate_gtf.py
```

Output files:
- `output/top_regions_df.pkl`: Stores merged SE region information ranked by SE count (or sample count, etc.) (default: top 20).
- `output/unsorted_temp.gtf`: Temporary file.
- `output/modified_for_featurecounts.gtf`: featureCounts GTF file corresponding to merged SE regions in top_regions_df.pkl.

### 2. Generate BAM File List

Specify the directory containing BAM files to create a file list:

```bash
./generate_file_list.sh /path/to/bam_directory
```

- Full paths of BAM files will be output to `output/bam_list.txt`.
- You may need to grant execution permissions using `chmod +x generate_file_list.sh`.

### 3. Execute featureCounts Jobs

Here's an example of batch processing using `output/bam_list.txt`. There are two methods for running featureCounts:

#### 3.1 Run as Array Jobs (for Computer Clusters)

```bash
qsub -t 1-$(wc -l < output/bam_list.txt) run_featurecounts_array.sh
```

The provided `run_featurecounts_array.sh` is a script for Oracle Grid Engine (OGE, formerly Sun Grid Engine: SGE):

```bash
#!/bin/bash
#$ -S /bin/bash
#$ -cwd
#$ -jc your_job_class   # Specify job class
#$ -o ./output/featurecounts_output/logs/
#$ -e ./output/featurecounts_output/logs/

# Get BAM file (using SGE_TASK_ID)
bam_file=$(sed -n "${SGE_TASK_ID}p" output/bam_list.txt)
...
```

Notes:
- This example shows commands and scripts for Oracle Grid Engine.
- Modify execution commands according to your job scheduler:
  - For SLURM: `sbatch --array=1-$(wc -l < output/bam_list.txt) run_featurecounts_array.sh`
  - For PBS/Torque: `qsub -J 1-$(wc -l < output/bam_list.txt) run_featurecounts_array.sh`
- Script files need to be adjusted for your environment:
  - For SLURM: Use `#SBATCH` directives and change `${SGE_TASK_ID}` to `${SLURM_ARRAY_TASK_ID}`.
  - For PBS/Torque: Use `#PBS` directives and change `${SGE_TASK_ID}` to `${PBS_ARRAY_INDEX}`.
- Adjust resource specifications (memory, cores, time limits, etc.) according to your computing environment.

#### 3.2 Sequential Local Execution

For single machine execution, use `run_featurecounts_local.sh`:

1. Grant execution permissions (if needed)
```bash
chmod +x run_featurecounts_local.sh
```

2. Run the script
```bash
./run_featurecounts_local.sh
```

- Processes BAM files one by one.
- Results are output to `output/featurecounts_output/`.
- Logs are saved in `output/featurecounts_output/logs/`.
- Edit script parameters and resource settings in the script as needed for your environment.

### 4. Retrieve BAM File Read Counts

Get read counts for each BAM file from the file list and compile them into a CSV:

```bash
./bam_count.sh output/bam_list.txt
```

Output:
- `output/bam_read_counts.csv`: Read counts for each BAM file.

### 5. Merge featureCounts Output and Calculate CPM

Use `merge_featurecount_CPM.py` to merge featureCounts results and calculate CPM using the read count CSV (`bam_read_counts.csv`):

```bash
python merge_featurecount_CPM.py
```

Output:
- `output/merge_featurecount_CPM.pkl`: pkl file after merging and CPM calculation.

### 6. Create 0-indexed Data

Run `convert_merge_featurecount_CPM_zero_indexed.py` to convert data to 0-indexed:

```bash
python convert_merge_featurecount_CPM_zero_indexed.py --export_csv
```

- Adding `--export_csv` will also output a CSV file with the same base name.
- By default, generates `output/merge_featurecount_CPM_zero_indexed.pkl`.

### 7. Perform Correlation Analysis

Use `correlation_analysis.py` to calculate Pearson correlations between SE (CPM) and genes (TPM) and generate graphs:

```bash
python correlation_analysis.py \
  --top_regions_df ./output/top_regions_df.pkl \
  --se_count 10 \  # Specify number of top-ranked merged SEs to analyze
  --output_dir cli_cor_test \
  --merge_featurecount_pkl ./output/merge_featurecount_CPM_zero_indexed.pkl \
  --rna_csv path/to/gene_tpm.csv \
  --full_info_pkl temp_full_df_info.pkl \
  --use_all_samples
```

- `--se_count`: Specifies the number of top-ranked merged SEs to analyze.
- `--use_all_samples`: Uses all common samples regardless of `SAMPLE_distinct`.
- Results are saved in the specified `--output_dir`.
- Add `--save_png` option to save in PNG format.

## Notes

- Check `--help` option or source code comments for script arguments and behavior.
- BAM files and RNA CSV formats should be properly formatted beforehand. The RNA CSV format should be identical to those used in [P2GL](https://github.com/hamamoto-lab/SEgene/blob/main/peak_to_gene_links/README.md) and [SEgene_package](https://github.com/hamamoto-lab/SEgene/blob/main/SE_to_gene_links/README.md).
- Adjust job submission methods in scripts according to your job management system (SGE, SLURM, etc.).
- Modify permissions (`chmod +x`) and set paths as needed during processing.

Following these steps, you can perform a series of analyses (GTF generation, featureCounts jobs, CPM calculation, correlation analysis) using ChIP-Seq and RNA data.

## License

This program is released under the MIT License. For more details, please refer to the [LICENSE](https://github.com/hamamoto-lab/SEgene/blob/main/LICENSE) file.

## Citation

If you use this tool in your research, please cite:

Shinkai, N., Asada, K., Machino, H., Takasawa, K., Takahashi, S., Kouno, N., Komatsu, M., Hamamoto, R., & Kaneko, S. (2025). SEgene identifies links between super enhancers and gene expression across cell types. *npj Systems Biology and Applications*, 11(1), 49. https://doi.org/10.1038/s41540-025-00533-x